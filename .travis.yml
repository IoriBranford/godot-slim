language: cpp

# OS config, depends on actual 'os' in build matrix
dist: trusty
sudo: false

env:
  global:
    - SCONS_CACHE=$HOME/.scons_cache
    - SCONS_CACHE_LIMIT=1024
    - OPTIONS="target=release tools=no verbose=yes progress=no gdnative_wrapper=no use_lto=yes"
    - MODULES="module_bullet_enabled=yes module_dds_enabled=no module_enet_enabled=no module_etc_enabled=no module_freetype_enabled=yes module_gdnative_enabled=no module_gdscript_enabled=yes module_gridmap_enabled=no module_hdr_enabled=no module_jpg_enabled=no module_mobile_vr_enabled=no module_mono_enabled=no module_ogg_enabled=yes module_openssl_enabled=no module_opus_enabled=no module_pvr_enabled=no module_recast_enabled=no module_regex_enabled=no module_squish_enabled=no module_stb_vorbis_enabled=no module_svg_enabled=no module_tga_enabled=no module_thekla_unwrap_enabled=no module_theora_enabled=no module_tinyexr_enabled=no module_visual_script_enabled=no module_vorbis_enabled=yes module_webm_enabled=no module_webp_enabled=no"
    - secure: "QLFRizqry/Y5pnEZvDlQz5S3YydQ+600u4rHEzFgUTd0heYeQaETXAQeMzp0ymuG1BkdRAl5YJoLVJgAzjwI9hrvugvoUlh2//SfpqZCHN/Q1fYbtGgNTn01R3VFEpcfYQL93I2EjrxVm0WTM4PwCvMO+hU0aWTRDvCt1Lty0kMR+RMDQOO/woqunoXh5wvFNxTJJkAmuLe0v962DJYOIwJAnqMLR0aFYjmeQJ20bc/2X5oLt+WuJDuf/lGj6WSlD6z/o/kL3YxHoUyw4A/HAZ2IX0IfNHKuay60ESWzl/NlobnePiPwHAE2pdDVu//q16fanb9VeYnBYRFse49TpFRb86Lo+Qz8nKDJqpQEIY0YKNCFqekrubqTM++Lj6QvGpykQZNxUhybmELcEsRG4PS0UMvCpebdnJD46nNB+DtO2Lgb4xXDLQwpq19z1wizq/XDQ5hz61TIIx8+i8TsgdSQKCTeWovd4HcD4CVjAD5XTLGgyRmI/zC2d+lTnKo6W9diLq/bX/Goq2QPeaTPABqv817IaJka2JyugQ7Qal/+gNTjYRRsimRCL9B2tVh+Uh8rWhTFhQL4QbP5P65HF+p8qojUzqtAhPMbZ8mxUtNukUI3liVgPgiMss96sG0nTVglFgkkAkEjIMFnqMSKnTfG812K4jIhp2jCO2Q3NeI="

cache:
  directories:
    - $SCONS_CACHE

matrix:
  include:
    - env: GODOT_TARGET=x11 CACHE_NAME=${GODOT_TARGET}-clang
      os: linux
      compiler: clang
      addons:
        apt:
          packages:
            - &linux_deps [libasound2-dev, libfreetype6-dev, libgl1-mesa-dev, libglu1-mesa-dev, libx11-dev, libxcursor-dev, libxi-dev, libxinerama-dev, libxrandr-dev]

    - env: GODOT_TARGET=android CACHE_NAME=${GODOT_TARGET}-clang
      os: linux
      compiler: clang

    - env: GODOT_TARGET=osx CACHE_NAME=${GODOT_TARGET}-tools-clang
      os: osx
      osx_image: xcode9.3
      compiler: clang

    - env: GODOT_TARGET=iphone CACHE_NAME=${GODOT_TARGET}-clang
      os: osx
      osx_image: xcode9.3
      compiler: clang

install:
  - if [ "$TRAVIS_OS_NAME" = "linux" ] && [ "$GODOT_TARGET" = "android" ]; then
      misc/travis/android-tools-linux.sh;
    fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then
      misc/travis/scons-local-osx.sh;
    fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ] && [ "$GODOT_TARGET" = "android" ]; then
      misc/travis/android-tools-osx.sh;
    fi

before_script:
  - if [ "$GODOT_TARGET" = "android" ]; then
      export ANDROID_HOME=$TRAVIS_BUILD_DIR/godot-dev/build-tools/android-sdk;
      export ANDROID_NDK_ROOT=$TRAVIS_BUILD_DIR/godot-dev/build-tools/android-ndk;
    fi

script:
  - scons -j2 CC=$CC CXX=$CXX platform=$GODOT_TARGET $EXTRA_ARGS $OPTIONS $MODULES disable_3d=yes;
    cp -r bin bin2d;
    scons -j2 CC=$CC CXX=$CXX platform=$GODOT_TARGET $EXTRA_ARGS $OPTIONS $MODULES disable_advanced_gui=yes;
    cp -r bin binsimpleui;
    scons -j2 CC=$CC CXX=$CXX platform=$GODOT_TARGET $EXTRA_ARGS $OPTIONS $MODULES disable_3d=yes disable_advanced_gui=yes;
    cp -r bin bin2dsimpleui

after_success:
  - ls -l bin*
#  - if [ "$GODOT_TARGET" = "osx" ]; then
#      cp -r misc/dist/osx_tools.app ./Godot.app;
#      mkdir -p Godot.app/Contents/MacOS;
#      cp bin/godot.osx.tools.64 Godot.app/Contents/MacOS/Godot;
#      chmod +x Godot.app/Contents/MacOS/Godot;
#    fi
